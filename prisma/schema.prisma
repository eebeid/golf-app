generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}


model Tournament {
  id        String   @id @default(uuid())
  name      String
  slug      String   @unique @default(cuid()) // For URL: /t/williamsburg-2026
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  ownerId   String?  // Optional for now to support legacy/public
  owner     User?    @relation(fields: [ownerId], references: [id])

  settings  Settings? // 1:1
  players   Player[]
  teeTimes  TeeTime[]
  messages  Message[]
  photos    Photo[]
  
  courses     Course[]
  scorecards  Scorecard[]
  lodging     Lodging[]
  restaurants Restaurant[]
}



model Player {
  id             String   @id @default(uuid())
  name           String
  email          String?  // Removed @unique to allow same email in multiple tournaments
  handicapIndex  Float    @default(0.0)
  teeRiver       String?  @default("Gold")
  teePlantation  String?  @default("Gold")
  teeRNK         String?  @default("Gold")
  hcpRiver       Int      @default(0)
  hcpPlantation  Int      @default(0)
  hcpRNK         Int      @default(0)
  courseData     Json?    @default("{}") // JSON map: courseId -> { tee: string, hcp: number }
  phone          String?
  registeredAt   DateTime @default(now())
  
  scores         Score[]
  restaurants    Restaurant[]
  lodgings       LodgingPlayer[]
  
  tournamentId   String?
  tournament     Tournament? @relation(fields: [tournamentId], references: [id], onDelete: Cascade)

  // Ensure unique email per tournament
  @@unique([email, tournamentId])
}

model Score {
  id              String   @id @default(uuid())
  player          Player   @relation(fields: [playerId], references: [id], onDelete: Cascade)
  playerId        String
  
  course          Course   @relation(fields: [courseId], references: [id])
  courseId        String
  
  hole            Int
  score           Int
  stablefordPoints Int     @default(0)
  strokesReceived Int      @default(0)
  createdAt       DateTime @default(now())

  @@unique([playerId, courseId, hole])
}

model Course {
  id           String     @id @default(uuid())
  name         String
  address      String?
  par          Int        @default(72)
  tees         Json?      // Store tee info (color, rating, slope)
  holes        Json?      // Store handicap info per hole
  
  tournamentId String
  tournament   Tournament @relation(fields: [tournamentId], references: [id], onDelete: Cascade)
  scores       Score[]
}

model Lodging {
  id           String     @id @default(uuid())
  name         String
  address      String?
  unitNumber   String?    // e.g. "Unit 4B", "Room 201"
  url          String?
  notes        String?
  checkIn      String?
  checkOut     String?
  image        String?    // Base64 or URL
  
  tournamentId String
  tournament   Tournament @relation(fields: [tournamentId], references: [id], onDelete: Cascade)
  players      LodgingPlayer[]
}

model LodgingPlayer {
  id        String  @id @default(uuid())
  lodgingId String
  playerId  String
  lodging   Lodging @relation(fields: [lodgingId], references: [id], onDelete: Cascade)
  player    Player  @relation(fields: [playerId], references: [id], onDelete: Cascade)

  @@unique([lodgingId, playerId])
}

model Restaurant {
  id           String     @id @default(uuid())
  name         String
  address      String?
  cuisine      String?
  url          String?
  phone        String?
  rating       Int?
  notes        String? // Recommended dishes etc.
  date         String? // Reservation date

  lat          Float?
  lng          Float?

  payerId      String?
  payer        Player?  @relation(fields: [payerId], references: [id])
  paymentLink  String?
  
  tournamentId String
  tournament   Tournament @relation(fields: [tournamentId], references: [id], onDelete: Cascade)
}

model Photo {
  id        String   @id @default(uuid())
  url       String
  caption   String?
  createdAt DateTime @default(now())

  tournamentId   String?
  tournament     Tournament? @relation(fields: [tournamentId], references: [id], onDelete: Cascade)
}

model Settings {
  id                    String   @id @default(uuid())
  numberOfRounds        Int      @default(0)
  roundDates            Json     @default("[]")
  roundCourses          Json     @default("[]")
  roundTimeConfig       Json     @default("{}")
  totalPlayers          Int      @default(0)
  showAccommodations    Boolean  @default(true)
  showFood              Boolean  @default(true)

  showPhotos            Boolean  @default(false)
  tournamentName        String   @default("Golf Tournament")
  logoUrl               String?  
  prizesTitle           String?  @default("Tournament Prizes")
  prizes                Json?    @default("[]")
  updatedAt             DateTime @updatedAt

  venmo                 String?
  paypal                String?
  zelle                 String?

  tournamentId          String?  @unique
  tournament            Tournament? @relation(fields: [tournamentId], references: [id], onDelete: Cascade)
}

model Message {
  id        String   @id @default(uuid())
  text      String
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id])
  userId    String

  tournamentId   String?
  tournament     Tournament? @relation(fields: [tournamentId], references: [id], onDelete: Cascade)
}

model TeeTime {
  id        String   @id @default(uuid())
  round     Int
  time      String
  players   Json     
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tournamentId   String?
  tournament     Tournament? @relation(fields: [tournamentId], references: [id], onDelete: Cascade)
}


// NextAuth Models

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String?   @unique
  emailVerified DateTime?
  image         String?
  accounts      Account[]
  sessions      Session[]
  messages      Message[]
  tournaments   Tournament[]
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model HistoricalTrip {
  id        String   @id @default(uuid())
  name      String
  date      DateTime @default(now())
  data      Json
}

model Scorecard {
  id        String   @id @default(uuid())
  imageUrl  String   // Base64 or URL
  round     Int      
  playerIds Json     // List of Player IDs or Names
  createdAt DateTime @default(now())

  tournamentId String
  tournament   Tournament @relation(fields: [tournamentId], references: [id], onDelete: Cascade)
}
